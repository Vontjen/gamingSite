<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <meta charset="UTF-8">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="style.css"/>
    <title>Title</title>
</head>
<body>

<div class="container">
    <table class="table table-striped">
        <thead>
        <tr>
            <th>Id</th>
            <th>Name</th>
            <th>Developer</th>
            <th>Publisher</th>
            <th>Picture</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="game-list-data">

        </tbody>
    </table>

<form id="game-create-form">
    <div class="form-group">
        <label for="name">name:</label>
        <input class="form-control" id="name" name="name"/>
    </div>
    <div class="form-group">
        <label for="developer">developer</label>
        <input class="form-control" id="developer" name="developer"/>
    </div>
    <div class="form-group">
        <label for="publisher">publisher</label>
        <input class="form-control" id="publisher" name="publisher"/>
    </div>
    <!--<div class="form-group">
        <label for="picture">picture</label>
        <input class="form-control" id="picture" name="picture"/>
    </div>-->
    <input type="submit" class="btn btn-primary" value="Create">
</form>
</div>

<script>

    function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [null, ''])[1].replace(/\+/g, '%20')) || null;
    }
    let uid = getURLParameter('userId');

    $('#game-create-form').submit(function(e) {
        e.preventDefault();


        let p = {
            name: $(this.name).val(),
            developer: ({
                id:$(this.developer).val()
            }),
            publisher: ({
                id:$(this.publisher).val()
            })
        };

        $.ajax({
            method: 'POST',
            url: '/api/game',
            contentType: 'application/json',
            data: JSON.stringify(p),
            success: loadGames
        });

        this.reset();
    });

    loadGames();

    function loadGames() {
        $.getJSON('/api/game/all', function (games) {
            let $tbody = $("#game-list-data").empty();

            for (let game of games) {
                let $removeButton = $("<button>").addClass("btn").addClass("btn-danger").text("Remove");
                $removeButton.click(function(e) {
                    $.ajax({
                        method: 'delete',
                        url: `/api/game/${game.id}`,
                        success: loadGames
                    });
                });

                let $row = $('<tr>')
                    .append($('<td>').text(game.id))
                    .append($('<td>').append($('<a href="gamedetails.html?gameId='+game.id+'&userId='+uid+'">').text(game.name)))
                    .append($('<td>').text(game.developer.name))
                    .append($('<td>').text(game.publisher.name))
                    .append($('<td>').append($("<img>").attr("src","data:image/png;base64," + game.picture)))
                    .append($('<td>').append($removeButton));
                $tbody.append($row);



            }
    });
    }
</script>

</body>
</html>